<!DOCTYPE html>
<html>
<head>
    <title>Black Death: The Chronicles</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #2c3e50;
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
            color: #ecf0f1;
        }

        /* --- MENU SCREEN STYLES --- */
        #menu-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #2c3e50 0%, #000000 100%);
            z-index: 10;
        }

        h1 {
            font-size: 24px;
            color: #f1c40f;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 4px 4px 0 #000;
            line-height: 1.5;
            padding: 0 20px;
        }

        h2 {
            font-size: 12px;
            color: #bdc3c7;
            margin-bottom: 40px;
            font-weight: normal;
        }

        .card-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .game-card {
            width: 160px;
            height: 180px;
            background: #34495e;
            border: 4px solid #7f8c8d;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.1s, border-color 0.1s;
            box-shadow: 0 8px 0 #1a252f;
        }

        .game-card:active {
            transform: translateY(4px);
            box-shadow: 0 4px 0 #1a252f;
        }

        .game-card:hover {
            border-color: #ecf0f1;
        }

        .icon {
            font-size: 40px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 10px;
            text-align: center;
            line-height: 1.4;
            color: #fff;
        }

        /* --- GAME CONTAINER --- */
        #game-frame {
            border: none;
            width: 100%;
            height: 100%;
            display: none; /* Hidden by default */
            background: #000;
        }

        /* --- HOME BUTTON --- */
        #home-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: 2px solid #fff;
            padding: 8px 10px;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            cursor: pointer;
            display: none; /* Hidden on menu */
        }
        #home-btn:hover {
            background: #c0392b;
        }

    </style>
</head>
<body>

    <button id="home-btn" onclick="goHome()"> < HOME</button>

    <div id="menu-screen">
        <h1>THE BLACK DEATH<br>CHRONICLES</h1>
        <h2>Select your path</h2>

        <div class="card-container">
            <div class="game-card" onclick="playGame('urban')">
                <div class="icon">üè†</div>
                <div class="card-title">URBAN<br>LANDLORD</div>
            </div>

            <div class="game-card" onclick="playGame('farm')">
                <div class="icon">üçá</div>
                <div class="card-title">VINEYARD<br>OWNER</div>
            </div>
        </div>
    </div>

    <iframe id="game-frame"></iframe>

    <textarea id="code-urban" style="display:none;">
<!DOCTYPE html>
<html>
<head>
    <title>Black Death: The Verdict</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Press Start 2P', cursive;
            background-color: #2c3e50; 
            color: #ecf0f1; 
            text-align: center; 
            margin: 0; padding: 0;
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            height: 100vh;
            user-select: none;
            -webkit-user-select: none;
        }
        #top-bar {
            background: #34495e;
            padding: 5px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 45px;
            border-bottom: 4px solid #2c3e50;
            z-index: 20;
        }
        .stat-group { display: flex; flex-direction: column; align-items: center; }
        .stat-label { font-size: 8px; color: #bdc3c7; margin-bottom: 4px; }
        .stat-val { font-size: 10px; color: #f1c40f; }
        #game-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #2c3e50;
            position: relative;
        }
        canvas { 
            width: 100%;
            height: 100%;
            background-color: #87CEEB;
            image-rendering: pixelated; 
        }
        #plague-ticker {
            position: absolute;
            top: 10px; width: 100%;
            text-align: center;
            color: #c0392b; font-size: 12px;
            display: none;
            text-shadow: 1px 1px 0 #fff;
            pointer-events: none;
        }
        #game-over-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .result-title { font-size: 20px; color: #f1c40f; margin-bottom: 10px; text-shadow: 2px 2px #000; }
        .result-rank { font-size: 12px; color: #ecf0f1; margin-bottom: 20px; }
        .leaderboard {
            background: #34495e;
            border: 2px solid #ecf0f1;
            padding: 10px;
            width: 80%;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .lb-row {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            padding: 5px 0;
            border-bottom: 1px solid #7f8c8d;
        }
        .lb-row.player { color: #f1c40f; font-weight: bold; }
        #restart-btn {
            font-family: 'Press Start 2P', cursive;
            padding: 15px 20px;
            background: #27ae60; color: white;
            border: 4px solid #2ecc71;
            font-size: 14px;
            cursor: pointer;
            width: 200px;
        }
        #restart-btn:active { transform: translateY(4px); }
        #controls-bar {
            background: #2c3e50;
            height: 120px; 
            display: flex;
            justify-content: center;
            align-items: center;
            padding-bottom: 20px; 
        }
        .control-panel {
            background: #34495e;
            border-radius: 15px;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 20px;
            border: 2px solid #ecf0f1;
        }
        button { 
            font-family: 'Press Start 2P', cursive;
            width: 80px; height: 70px;
            font-size: 30px; cursor: pointer; 
            background: #e67e22; color: white; border: none;
            border-radius: 10px;
            box-shadow: 0 6px #d35400;
            touch-action: manipulation;
        }
        button:active { 
            box-shadow: 0 0 #d35400; 
            transform: translateY(6px); 
        }
        #rent-display-box { text-align: center; width: 100px; }
        .rent-label { font-size: 8px; color: #bdc3c7; display: block; margin-bottom: 8px; }
        #rentDisplay { font-size: 24px; color: white; }
        #month-bar-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: #2c3e50;
        }
        #month-bar { width: 0%; height: 100%; background: #2ecc71; transition: width 0.1s linear; }
    </style>
</head>
<body>
    <div id="top-bar">
        <div class="stat-group"><span class="stat-label">DATE</span><span class="stat-val" id="dateDisplay">Jan 1345</span></div>
        <div class="stat-group"><span class="stat-label">POPULATION</span><span class="stat-val" id="popDisplay" style="color:white">35</span></div>
        <div class="stat-group"><span class="stat-label">MY WEALTH</span><span class="stat-val" id="wealthDisplay" style="color:#2ecc71; font-size:12px;">0g</span></div>
        <div class="stat-group"><span class="stat-label">AVG RENT</span><span class="stat-val" id="avgRentDisplay" style="color:#3498db">45g</span></div>
    </div>
    <div id="game-container">
        <div id="plague-ticker">THE PLAGUE HAS ARRIVED</div>
        <div id="game-over-screen">
            <div class="result-title" id="final-title">GAME OVER</div>
            <div class="result-rank" id="final-rank">You placed #2</div>
            <div class="leaderboard" id="leaderboard"></div>
            <button id="restart-btn" onclick="restartGame()">PLAY AGAIN</button>
        </div>
        <div id="month-bar-container"><div id="month-bar"></div></div>
        <canvas id="gameCanvas" width="900" height="500"></canvas>
    </div>
    <div id="controls-bar">
        <div class="control-panel">
            <button ontouchstart="adjustRent(-1)" onmousedown="adjustRent(-1)">-</button>
            <div id="rent-display-box">
                <span class="rent-label">SET RENT</span>
                <span id="rentDisplay">45g</span>
            </div>
            <button ontouchstart="adjustRent(1)" onmousedown="adjustRent(1)">+</button>
        </div>
    </div>
<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const C = { sky: '#87CEEB', hills: '#27ae60', ground: '#7f8c8d', cobble: '#95a5a6', timber: '#5c4033', wall: '#fdf5e6', roof: '#c0392b', winLit: '#f1c40f', winDark: '#2c3e50', playerHighlight: '#f39c12' };
    const PALETTE = { skin: ['#fceabb', '#ffdbac', '#e0ac69'], hair: ['#2c3e50', '#8e44ad', '#d35400', '#f1c40f', '#5d4037'], clothes: ['#3498db', '#e74c3c', '#2ecc71', '#9b59b6', '#f39c12', '#ecf0f1', '#34495e'], sickSkin: '#00ff00' };
    const GROUND_Y = 400; const MONTH_FRAMES = 120; const PLAYER_HOUSE_IDX = 2; const END_YEAR = 1352;
    let state = { year: 1345, month: 0, monthTimer: 0, isPlague: false, gameActive: true, playerRent: 45, avgRent: 45, population: [], houses: [], floatingTexts: [], hills: [], targetPop: 35 };
    class FloatingText { constructor(x, y, text, color) { this.x = x; this.y = y; this.text = text; this.color = color; this.life = 50; } draw() { ctx.fillStyle = this.color; ctx.font = "14px 'Press Start 2P'"; ctx.fillText(this.text, this.x, this.y); this.y -= 0.8; this.life--; } }
    class House {
        constructor(x, index, isPlayer) {
            this.x = x; this.y = GROUND_Y; this.w = 140; this.h = 170; this.isPlayer = isPlayer; this.index = index; this.slots = 5; this.tenants = []; this.price = isPlayer ? 45 : Math.floor(Math.random() * 10 + 40); this.wealth = 0; this.aiTimer = 0;
            if(index === 0) { this.aiType = 'undercutter'; this.name = "The Cutter"; } if(index === 1) { this.aiType = 'follower'; this.name = "The Sheep"; } if(index === 2) { this.aiType = 'player'; this.name = "YOU"; } if(index === 3) { this.aiType = 'gouger'; this.name = "The Miser"; } if(index === 4) { this.aiType = 'wildcard'; this.name = "The Jester"; }
        }
        get occupancy() { return this.tenants.length; }
        addTenant(person) { if(this.occupancy < this.slots) { this.tenants.push(person); return true; } return false; }
        removeTenant(person) { this.tenants = this.tenants.filter(t => t !== person); }
        updateAI() {
            if(this.isPlayer) return;
            this.aiTimer++;
            if(this.aiTimer > 30) { 
                this.aiTimer = 0; let marketMean = state.avgRent;
                switch(this.aiType) { case 'undercutter': this.price = Math.max(5, marketMean - 3); break; case 'follower': if(this.price > marketMean) this.price--; else if(this.price < marketMean) this.price++; break; case 'gouger': if(this.occupancy === 0) this.price = Math.max(5, marketMean); else this.price = marketMean + 4; break; case 'wildcard': if(Math.random() > 0.6) this.price += Math.floor(Math.random()*5 - 2); break; }
                if(this.occupancy === 0) this.price = Math.max(2, this.price - 1); this.price = Math.floor(this.price);
            }
        }
        collectRent() {
            let income = 0;
            for (let i = this.tenants.length - 1; i >= 0; i--) { let t = this.tenants[i]; if(t.budget < this.price) t.evict(); else income += this.price; }
            if(income > 0) { this.wealth += income; if(this.isPlayer) { state.floatingTexts.push(new FloatingText(this.x + 60, this.y - 120, `+${income}`, '#f1c40f')); updateUI(); } }
        }
        draw() {
            let hx = this.x; let hy = this.y - this.h;
            drawRect(hx, this.y-20, this.w, 20, '#7f8c8d'); drawRect(hx, hy, this.w, this.h-20, C.wall);
            ctx.fillStyle = C.roof; ctx.beginPath(); ctx.moveTo(hx - 10, hy); ctx.lineTo(hx + this.w/2, hy - 90); ctx.lineTo(hx + this.w + 10, hy); ctx.fill();
            ctx.lineWidth = 4; ctx.strokeStyle = C.timber; ctx.stroke();
            drawRect(hx, hy, 10, this.h-20, C.timber); drawRect(hx+this.w-10, hy, 10, this.h-20, C.timber);
            drawRect(hx, hy + 60, this.w, 10, C.timber); drawRect(hx, hy + 120, this.w, 10, C.timber);
            if(!this.isPlayer) { ctx.fillStyle = "rgba(255,255,255,0.7)"; ctx.fillRect(hx + 35, hy - 110, 50, 14); ctx.fillStyle = "black"; ctx.font = "10px 'Press Start 2P'"; ctx.fillText(this.wealth + "g", hx + 40, hy - 100); }
            for(let i=0; i<this.slots; i++) {
                let winX = hx + 20 + (i%3)*40; let winY = hy + 80; if(i >= 3) { winX = hx + 35 + (i%2)*40; winY = hy + 20; }
                let isOccupied = i < this.occupancy; drawRect(winX, winY, 24, 30, C.timber); drawRect(winX+2, winY+2, 20, 26, isOccupied ? C.winLit : C.winDark);
                if(isOccupied) { let tenant = this.tenants[i]; drawRect(winX+6, winY+14, 12, 12, tenant.skinColor); }
            }
            drawRect(hx+this.w/2 - 25, hy+150, 50, 20, '#ecf0f1'); ctx.fillStyle = '#2c3e50'; ctx.font = "10px 'Press Start 2P'"; ctx.fillText(this.price + "g", hx+this.w/2 - 15, hy+165);
            if(this.isPlayer) { ctx.strokeStyle = C.playerHighlight; ctx.lineWidth = 5; ctx.strokeRect(hx-3, hy-3, this.w+6, this.h-14); }
        }
    }
    class Person {
        constructor() { this.reset(true); }
        reset(isSpawn) {
            this.x = Math.random() * 800 + 50; this.y = GROUND_Y - 2; this.speed = 1.0 + Math.random() * 1.5; this.direction = Math.random() > 0.5 ? 1 : -1; this.isSick = false; this.sickTimer = 0; this.gender = Math.random() > 0.5 ? 'f' : 'm';
            this.skinColor = PALETTE.skin[Math.floor(Math.random()*3)]; this.hairColor = PALETTE.hair[Math.floor(Math.random()*5)]; this.clothesColor = PALETTE.clothes[Math.floor(Math.random()*7)];
            let base = state.isPlague ? 5 : 40; this.budget = base + Math.floor(Math.random() * 45); this.house = null; this.state = 'wandering'; this.targetHouse = null; this.animFrame = Math.random() * 100; this.patience = 0;
        }
        think() {
            if(this.state === 'wandering') { this.patience++; if(this.patience > 200) this.budget += 1; }
            if(this.state === 'housed') { this.patience = 0; if(this.budget > state.avgRent + 5) this.budget -= 0.1; }
            if(this.isSick) { let decay = this.state === 'housed' ? 0.5 : 1; this.sickTimer += decay; if(this.sickTimer > 100) { this.evict(); this.state = 'dying'; this.sickTimer = 0; } }
            if(this.state === 'dying') { this.sickTimer++; if(this.sickTimer > 90) this.state = 'dead'; return; }
            if (this.state === 'housed') {
                if(Math.random() < 0.01) { let betterOption = state.houses.find(h => h.price < this.house.price - 5 && h.occupancy < h.slots); if(betterOption) { this.evict(); this.targetHouse = betterOption; } }
                if(this.house && (this.house.price > this.budget)) this.evict(); return;
            }
            if (this.state === 'leaving') { this.x += (this.speed * this.direction); return; }
            if (!this.targetHouse || this.targetHouse.occupancy >= this.targetHouse.slots) { let options = state.houses.filter(h => h.price <= this.budget && h.occupancy < h.slots); if (options.length > 0) { options.sort((a,b) => a.price - b.price); this.targetHouse = options[0]; } else this.targetHouse = null; }
            if (this.targetHouse) {
                let tx = this.targetHouse.x + this.targetHouse.w/2;
                if (Math.abs(tx - this.x) < 5) { if (this.targetHouse.addTenant(this)) { this.house = this.targetHouse; this.state = 'housed'; if(this.targetHouse.isPlayer) state.floatingTexts.push(new FloatingText(this.x, this.y-50, "!", "#2ecc71")); } else this.targetHouse = null; } else this.x += (tx > this.x ? this.speed : -this.speed);
            } else { this.x += (this.speed * this.direction); if(this.x < 0 || this.x > 900) { this.direction *= -1; if(Math.random() < 0.2) this.reset(true); } }
        }
        evict() { if(this.house) { this.house.removeTenant(this); this.house = null; this.state = 'wandering'; this.targetHouse = null; if(!this.isSick) state.floatingTexts.push(new FloatingText(this.x, this.y-60, "Moved!", "#c0392b")); } }
        draw() {
            if (this.state === 'housed' || this.state === 'dead') return;
            let px = this.x; let py = this.y;
            if(this.state === 'dying') { ctx.fillStyle = this.clothesColor; ctx.fillRect(px, py, 16, 8); ctx.fillStyle = this.skinColor; ctx.fillRect(px+16, py+2, 8, 8); if(this.sickTimer < 30) { ctx.fillStyle = "white"; ctx.fillText("cough", px, py-10); } return; }
            this.animFrame++; let walkCycle = Math.sin(this.animFrame * 0.2); let legOffset = walkCycle * 4; let bob = Math.abs(walkCycle) * 2;
            ctx.fillStyle = '#3e2723'; if(this.gender === 'm') { drawRect(px+4+legOffset, py-10, 3, 10, '#3e2723'); drawRect(px+10-legOffset, py-10, 3, 10, '#3e2723'); } else drawRect(px+2, py-10, 14, 10, this.clothesColor); 
            py -= bob; drawRect(px+2, py-24, 14, 14, this.clothesColor); if(this.gender === 'f') drawRect(px+5, py-22, 8, 10, '#ecf0f1'); else drawRect(px+2, py-16, 14, 3, '#2c3e50');
            ctx.fillStyle = this.clothesColor; let armSwing = -walkCycle * 4; drawRect(px-2+armSwing, py-22, 4, 10, this.clothesColor); drawRect(px+14-armSwing, py-22, 4, 10, this.clothesColor); drawRect(px-2+armSwing, py-12, 4, 3, this.skinColor); drawRect(px+14-armSwing, py-12, 4, 3, this.skinColor);
            drawRect(px+4, py-34, 10, 10, this.skinColor); ctx.fillStyle = this.hairColor; if(this.gender === 'f') { drawRect(px+3, py-35, 12, 4, this.hairColor); drawRect(px+2, py-32, 2, 8, this.hairColor); if(this.animFrame % 100 > 50) drawRect(px+4, py-36, 10, 3, 'white'); } else drawRect(px+3, py-36, 12, 4, this.hairColor);
        }
    }
    function init() {
        state.year = 1345; state.month = 0; state.gameActive = true; state.isPlague = false; state.hills = []; state.population = []; state.houses = []; state.floatingTexts = []; state.playerRent = 45;
        document.getElementById('game-over-screen').style.display = 'none'; document.getElementById('plague-ticker').style.display = 'none'; C.sky = '#87CEEB';
        for(let i=0; i<=900; i+=40) state.hills.push({x: i, y: GROUND_Y - 80 - Math.random()*25});
        let startX = (900 - (5 * 150)) / 2;
        for (let i = 0; i < 5; i++) state.houses.push(new House(startX + i * 150, i, i === PLAYER_HOUSE_IDX));
        for(let i=0; i<35; i++) state.population.push(new Person()); 
        gameLoop();
    }
    function restartGame() { init(); }
    function showGameOver() {
        state.gameActive = false;
        let rankings = [...state.houses].sort((a,b) => b.wealth - a.wealth); let playerRank = rankings.findIndex(h => h.isPlayer) + 1;
        document.getElementById('final-title').innerText = playerRank === 1 ? "VICTORY!" : "GAME OVER"; document.getElementById('final-title').style.color = playerRank === 1 ? "#2ecc71" : "#e74c3c"; document.getElementById('final-rank').innerText = `You ranked #${playerRank} of 5`;
        let html = ""; rankings.forEach((h, idx) => { let className = h.isPlayer ? "lb-row player" : "lb-row"; html += `<div class="${className}"><span>#${idx+1} ${h.name}</span><span>${h.wealth}g</span></div>`; });
        document.getElementById('leaderboard').innerHTML = html; document.getElementById('game-over-screen').style.display = 'flex';
    }
    function gameLoop() {
        if(!state.gameActive) return;
        state.monthTimer++; if(state.monthTimer >= MONTH_FRAMES) { state.monthTimer = 0; endMonth(); }
        let totalRent = 0; state.houses.forEach(h => { h.updateAI(); totalRent += h.price; }); state.avgRent = Math.floor(totalRent / 5);
        if(state.isPlague) state.targetPop = 10 + Math.floor(Math.sin(Date.now()/3000) * 3); else state.targetPop = 34 + Math.floor(Math.sin(Date.now()/4000) * 11); 
        state.population = state.population.filter(p => p.state !== 'dead');
        if(state.population.length < state.targetPop) { let chance = state.isPlague ? 0.01 : 0.05; if(Math.random() < chance) { let p = new Person(); if(state.isPlague && Math.random() < 0.5) { p.isSick = true; p.skinColor = PALETTE.sickSkin; p.budget = 5; } state.population.push(p); } }
        if(state.population.length > state.targetPop && Math.random() < 0.02) { let wanderers = state.population.filter(p => p.state === 'wandering'); if(wanderers.length > 0) wanderers[0].state = 'dead'; }
        state.population.forEach(p => p.think()); drawScene(); requestAnimationFrame(gameLoop);
    }
    function endMonth() { state.month++; if(state.month > 11) { state.month = 0; state.year++; if(state.year === 1348) triggerPlague(); if(state.year === END_YEAR) showGameOver(); } state.houses.forEach(h => h.collectRent()); updateUI(); }
    function triggerPlague() { state.isPlague = true; document.getElementById('plague-ticker').style.display = 'block'; C.sky = "#5e4b4b"; C.ground = "#5d4037"; C.hills = "#3e2723"; state.population.forEach(p => { if(Math.random() < 0.4) { p.isSick = true; p.skinColor = PALETTE.sickSkin; p.budget = Math.max(2, p.budget - 30); } }); }
    function drawScene() {
        ctx.clearRect(0, 0, 900, 500); ctx.fillStyle = C.sky; ctx.fillRect(0,0,900, GROUND_Y);
        ctx.fillStyle = C.hills; ctx.beginPath(); ctx.moveTo(0, GROUND_Y); ctx.lineTo(0, GROUND_Y-80); state.hills.forEach(pt => ctx.lineTo(pt.x, pt.y)); ctx.lineTo(900, GROUND_Y); ctx.fill();
        ctx.fillStyle = C.ground; ctx.fillRect(0, GROUND_Y, 900, 500-GROUND_Y); ctx.fillStyle = C.cobble;
        for(let y=GROUND_Y+5; y<500; y+=10) { for(let x=0; x<900; x+=25) { if((x+y)%50 === 0) drawRect(x, y, 15, 6, C.cobble); } }
        state.houses.forEach(h => h.draw()); state.population.sort((a,b) => a.y - b.y); state.population.forEach(p => p.draw()); state.floatingTexts = state.floatingTexts.filter(ft => ft.life > 0); state.floatingTexts.forEach(ft => ft.draw());
        document.getElementById('month-bar').style.width = ((state.monthTimer / MONTH_FRAMES) * 100) + "%";
    }
    function adjustRent(amount) { state.playerRent += amount; if(state.playerRent < 1) state.playerRent = 1; state.houses[PLAYER_HOUSE_IDX].price = state.playerRent; updateUI(); }
    function updateUI() {
        document.getElementById('rentDisplay').innerText = state.playerRent + "g"; document.getElementById('wealthDisplay').innerText = state.houses[PLAYER_HOUSE_IDX].wealth + "g"; document.getElementById('avgRentDisplay').innerText = state.avgRent + "g"; document.getElementById('popDisplay').innerText = state.population.length; const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]; document.getElementById('dateDisplay').innerText = months[state.month] + " " + state.year;
    }
    function drawRect(x, y, w, h, color) { ctx.fillStyle = color; ctx.fillRect(Math.floor(x), Math.floor(y), w, h); }
    document.fonts.ready.then(init);
</script>
</body>
</html>
    </textarea>

    <textarea id="code-farm" style="display:none;">
<!DOCTYPE html>
<html>
<head>
  <title>Black Death: The Grape Escape</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    body{ font-family:'Courier New', monospace; background-color:#2c3e50; color:#ecf0f1; text-align:center; margin:0; padding:0; overflow:hidden; display:flex; flex-direction:column; height:100vh; user-select:none; -webkit-user-select:none; }
    #top-bar{ background:linear-gradient(180deg,#27ae60 0%,#229954 100%); padding:5px; display:flex; justify-content:space-around; align-items:center; height:55px; border-bottom:4px solid #1e8449; z-index:20; }
    .stat-group{ display:flex; flex-direction:column; align-items:center; }
    .stat-label{ font-size:10px; color:#a9dfbf; margin-bottom:4px; font-weight:bold; }
    .stat-val{ font-size:14px; color:#fff; text-shadow:1px 1px 0 #000; font-weight:bold; }
    #game-container{ flex-grow:1; display:flex; justify-content:center; align-items:center; background:#2c3e50; position:relative; }
    canvas{ width:100%; height:100%; background-color:#87CEEB; image-rendering:pixelated; }
    #plague-ticker{ position:absolute; top:10px; width:100%; text-align:center; color:#c0392b; font-size:16px; display:none; text-shadow:2px 2px 0 #000; pointer-events:none; font-weight:bold; background:rgba(0,0,0,0.3); padding:8px 0; animation:pulse 2s infinite; z-index:50; }
    @keyframes pulse{ 0%,100%{opacity:1;} 50%{opacity:0.7;} }
    #game-over-screen{ position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(44,62,80,0.95); display:none; flex-direction:column; justify-content:center; align-items:center; z-index:100; }
    .result-title{ font-size:24px; color:#f1c40f; margin-bottom:20px; font-weight:bold; }
    #restart-btn{ padding:15px; background:#e67e22; color:white; border:4px solid #d35400; cursor:pointer; margin-top:20px; font-size:16px; font-weight:bold; }
    #controls-bar{ background:linear-gradient(180deg,#2e4053 0%,#1c2833 100%); height:130px; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:10px 0; border-top:3px solid #34495e; }
    .control-panel{ background:#34495e; border-radius:15px; padding:15px; display:flex; align-items:center; gap:20px; border:3px solid #4a5f7f; box-shadow:0 4px 8px rgba(0,0,0,0.3); }
    button{ width:80px; height:70px; font-size:30px; cursor:pointer; background:#e67e22; color:white; border:none; border-radius:10px; box-shadow:0 6px #d35400; touch-action:manipulation; }
    button:active{ box-shadow:0 0 #d35400; transform:translateY(6px); }
    #wage-display-box{ text-align:center; width:140px; }
    .wage-label{ font-size:10px; color:#bdc3c7; display:block; margin-bottom:8px; }
    #wageDisplay{ font-size:30px; color:white; font-weight:bold; }
    .wage-hint{ font-size:10px; color:#7f8c8d; margin-top:5px; }
    #month-bar-container{ position:absolute; top:0; left:0; width:100%; height:6px; background:rgba(44,62,80,0.8); }
    #month-bar{ width:0%; height:100%; background:linear-gradient(90deg,#f1c40f 0%,#f39c12 100%); }
  </style>
</head>
<body>
  <div id="top-bar">
    <div class="stat-group"><span class="stat-label">YEAR</span><span class="stat-val" id="dateDisplay">1345</span></div>
    <div class="stat-group"><span class="stat-label">WORKERS</span><span class="stat-val" id="popDisplay">25</span></div>
    <div class="stat-group"><span class="stat-label">GOLD</span><span class="stat-val" id="wealthDisplay" style="color:#f1c40f">500</span></div>
    <div class="stat-group"><span class="stat-label">AVG WAGE</span><span class="stat-val" id="avgWageDisplay" style="color:#3498db">5g</span></div>
  </div>
  <div id="game-container">
    <div id="plague-ticker">THE BLACK DEATH HAS ARRIVED</div>
    <div id="game-over-screen">
      <div class="result-title" id="final-title">HARVEST ENDED</div>
      <div id="leaderboard"></div>
      <button id="restart-btn" onclick="startGame()">NEXT SEASON</button>
    </div>
    <div id="month-bar-container"><div id="month-bar"></div></div>
    <canvas id="gameCanvas" width="900" height="500"></canvas>
  </div>
  <div id="controls-bar">
    <div class="control-panel">
      <button id="btnMinus">-</button>
      <div id="wage-display-box"><span class="wage-label">OFFER WAGE</span><span id="wageDisplay">5g</span><div class="wage-hint" id="wageHint">Match market</div></div>
      <button id="btnPlus">+</button>
    </div>
  </div>
<script>
    const HARVEST_SPEED = 0.95; const ROT_TIME = 720; const REGROW_COOLDOWN = 280; const REGROW_CHANCE = 0.009; const WALK_TO_COL_SPEED = 1.85; const WORKER_WANDER_X = 1.00; const WORKER_WANDER_Y = 0.55; const LEAVING_Y_SPEED = 1.8; const LEAVING_X_MULT = 1.75; const PERSPECTIVE_POW = 2.2; const CONVERGE = 0.70; const VANISH_LEFT = -90; const ARC_LEFT = 34; const ARC_POWER = 1.6;
    let canvas, ctx; const HORIZON_Y = 160; const GROUND_Y = 400; const MONTH_FRAMES = 90; const END_YEAR = 1352; const PLAYER_IDX = 2; const GRAPE_VALUE = 80;
    const AI = { REACT_FRAMES: 18, STEP_UP: 1, STEP_DOWN: 1, MAX_WAGE: GRAPE_VALUE - 2, MIN_WAGE: 1 };
    const C = { sky: '#87CEEB', hills: '#27ae60', ground: '#5d4037', vine: '#2ecc71', grape: '#8e44ad', rot: '#4e342e', playerHighlight: '#f39c12', skin: ['#fceabb', '#ffdbac', '#e0ac69'], hats: { 'Mercenary':'#c0392b', 'Desperate':'#7f8c8d', 'Stubborn':'#2980b9', 'Steady':'#2ecc71' } };
    let state = { year:1345, month:0, monthTimer:0, isPlague:false, gameActive:false, playerWage:5, avgWage:5, population:[], vineyards:[], floatingTexts:[], hills:[], targetPop:25 };
    function clamp(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }
    function vineYFromPct(pct){ const t = clamp(pct / 100, 0, 1); const dist = (GROUND_Y - HORIZON_Y); const eased = 1 - Math.pow(1 - t, PERSPECTIVE_POW); return GROUND_Y - dist * eased; }
    function projectX(baseX, vx, w, t){ const vanishX = (vx + w*0.5) + VANISH_LEFT; const convergeAmt = clamp(t * CONVERGE, 0, 1); const x1 = baseX + (vanishX - baseX) * convergeAmt; const bend = ARC_LEFT * Math.pow(t, ARC_POWER); return x1 - bend; }
    function marketSnapshot(){ const wages = state.vineyards.map(v => v.wage).slice().sort((a,b)=>a-b); const avg = Math.floor(wages.reduce((s,x)=>s+x,0) / wages.length); const max = wages[wages.length-1]; const second = wages.length>=2 ? wages[wages.length-2] : max; return {avg, max, second}; }
    function laborSnapshot(){ let openSlots = 0; state.vineyards.forEach(v => openSlots += v.openCols); const workers = state.population.length; const laborTight = openSlots > 0 ? (workers / openSlots) : 2.0; const hiringPressure = state.vineyards.filter(v => v.openCols > 0).length; return {openSlots, workers, laborTight, hiringPressure}; }
    class FloatingText{ constructor(x,y,text,color){ this.x=x; this.y=y; this.text=text; this.color=color; this.life=60; } draw(){ ctx.save(); ctx.globalAlpha = this.life / 60; ctx.fillStyle = this.color; ctx.font = "bold 14px monospace"; ctx.fillText(this.text, this.x, this.y); ctx.restore(); this.y -= 0.45; this.life--; } }
    class Vineyard{
        constructor(x,index,isPlayer){ this.x=x; this.w=160; this.index=index; this.isPlayer=isPlayer; this.wage = isPlayer ? 5 : Math.floor(Math.random()*3 + 4); this.wealth = 500; this.aiTimer = 0; this.aiTargetWage = this.wage; this.cols = [ {x:30, status:1, rotTimer:0, regrow:0, worker:null, progress:0}, {x:60, status:1, rotTimer:0, regrow:0, worker:null, progress:0}, {x:90, status:1, rotTimer:0, regrow:0, worker:null, progress:0}, {x:120,status:1, rotTimer:0, regrow:0, worker:null, progress:0} ]; if(index===0) this.aiType='Aggressive'; if(index===1) this.aiType='Steady'; if(index===3) this.aiType='Panic'; if(index===4) this.aiType='Cheap'; }
        get openCols(){ return this.cols.filter(c => c.status===1 && c.worker===null).length; } get staffedCols(){ return this.cols.filter(c => c.worker!==null).length; }
        rotPressure(){ const unworked = this.cols.filter(c => c.status===1 && c.worker===null); if(unworked.length===0) return 0; let p=0; unworked.forEach(c => p += clamp(c.rotTimer / ROT_TIME, 0, 1)); return p / unworked.length; }
        assignWorker(worker){ const col = this.cols.find(c => c.status===1 && c.worker===null); if(col){ col.worker=worker; return col; } return null; }
        fireWorker(worker){ const col = this.cols.find(c => c.worker===worker); if(col) col.worker=null; }
        updateAI(){
            if(this.isPlayer) return; this.aiTimer++; if(this.aiTimer < AI.REACT_FRAMES) return; this.aiTimer = 0;
            const m = marketSnapshot(); const l = laborSnapshot(); const empty = this.openCols; const staffed = this.staffedCols; const rp = this.rotPressure(); const burnPerHarvest = Math.max(1, this.wage * Math.max(1, staffed)); const runway = this.wealth / burnPerHarvest; const poachThreat = state.vineyards.some(v => v !== this && v.openCols > 0 && v.wage >= this.wage + 1); let maxBid = AI.MAX_WAGE; if(state.isPlague) maxBid = Math.min(maxBid, GRAPE_VALUE - 5); let target = this.wage;
            const isAgg = this.aiType==='Aggressive'; const isPanic = this.aiType==='Panic'; const isCheap = this.aiType==='Cheap'; const cashScared = runway < (state.isPlague ? 1.8 : 1.2); const laborShortage = (l.laborTight < 1.05) || state.isPlague; const myHiring = empty > 0;
            if(rp > 0.70 && myHiring && !cashScared){ target = m.max + (isPanic ? 3 : isAgg ? 2 : 1); } else if(myHiring){ if(cashScared){ target = Math.max(m.avg, m.second); } else if(laborShortage){ if(isAgg) target = m.max + 2; else if(isPanic) target = m.max + 3; else if(isCheap) target = m.max + (rp > 0.35 ? 1 : 0); else target = m.max + 1; } else { if(isAgg) target = m.max + 1; else if(isPanic) target = m.max + 2; else if(isCheap) target = Math.max(2, m.avg - 1); else target = Math.max(3, m.avg); } } else { if(poachThreat){ if(isCheap) target = Math.max(m.second, m.max - 1); else if(cashScared) target = Math.max(m.avg, m.second); else target = isAgg ? m.max : Math.max(m.second, m.max); } else { if(isAgg) target = Math.max(2, m.avg - 1); else if(isPanic) target = Math.max(3, m.avg); else if(isCheap) target = Math.max(1, m.avg - 2); else target = Math.max(2, m.avg - 1); } }
            if(isAgg && !cashScared){ const others = state.vineyards.filter(v => v !== this && !v.isPlayer); const poorest = others.reduce((p,v)=> v.wealth < p.wealth ? v : p, others[0]); const richEnough = this.wealth > (poorest.wealth + 250); const preyIsHiring = poorest && poorest.openCols > 0; if(richEnough && preyIsHiring && (laborShortage || state.isPlague)){ target = Math.max(target, m.max + 2); } } if(isCheap && rp > 0.55 && myHiring && !cashScared){ target = Math.max(target, m.max + 1); } target = Math.min(target, maxBid); target = clamp(Math.round(target), AI.MIN_WAGE, AI.MAX_WAGE); this.aiTargetWage = target; if(this.wage < this.aiTargetWage) this.wage += AI.STEP_UP; else if(this.wage > this.aiTargetWage) this.wage -= AI.STEP_DOWN; this.wage = clamp(this.wage, AI.MIN_WAGE, AI.MAX_WAGE);
        }
        tickGrapes(){ this.cols.forEach(c => { if(c.status === 0){ if(c.regrow > 0) c.regrow--; else if(Math.random() < REGROW_CHANCE){ c.status = 1; c.rotTimer = 0; c.progress = 0; } } if(c.status === 1 && c.worker === null){ c.rotTimer++; if(c.rotTimer > ROT_TIME){ c.status = 2; if(this.isPlayer) state.floatingTexts.push(new FloatingText(this.x+c.x, GROUND_Y-50, "ROTTED!", '#c0392b')); } } if(c.status === 2){ c.rotTimer++; if(c.rotTimer > ROT_TIME + 140){ c.status = 0; c.regrow = REGROW_COOLDOWN; } } }); }
        harvestCol(colIdx){ const col = this.cols[colIdx]; if(col.status === 1){ this.wealth += GRAPE_VALUE; this.wealth -= this.wage; if(this.isPlayer) state.floatingTexts.push(new FloatingText(this.x+col.x, GROUND_Y-50, `+${GRAPE_VALUE-this.wage}g`, '#f1c40f')); } col.status = 0; col.worker = null; col.progress = 0; col.rotTimer = 0; col.regrow = REGROW_COOLDOWN; updateUI(); }
        draw(){
            const vx = this.x; ctx.fillStyle = this.isPlayer ? '#795548' : '#5d4037'; ctx.fillRect(vx, HORIZON_Y, this.w, GROUND_Y - HORIZON_Y); if(this.isPlayer){ ctx.strokeStyle = C.playerHighlight; ctx.lineWidth = 3; ctx.strokeRect(vx, HORIZON_Y, this.w, GROUND_Y - HORIZON_Y); } ctx.fillStyle = "rgba(255,255,255,0.8)"; ctx.fillRect(vx+10, HORIZON_Y-40, 120, 35); ctx.fillStyle = "black"; ctx.font = "bold 12px monospace"; ctx.fillText(this.wealth + "g", vx+15, HORIZON_Y-25); ctx.fillStyle = this.wage >= state.avgWage ? "#27ae60" : "#c0392b"; ctx.fillText("Pay:" + this.wage, vx+15, HORIZON_Y-10);
            this.cols.forEach(col => {
                const baseX = vx + col.x; ctx.strokeStyle = '#3e2723'; ctx.lineWidth = 4; ctx.beginPath(); const segs = 10; for(let s=0; s<=segs; s++){ const t = s / segs; const y = vineYFromPct(t * 100); const x = projectX(baseX, vx, this.w, t); if(s === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y); } ctx.stroke();
                if(col.status > 0){ const steps = 7; for(let i=0; i<steps; i++){ const t = i/(steps-1); const pct = t * 100; if(col.worker && pct < col.progress) continue; const y = vineYFromPct(pct); const x = projectX(baseX, vx, this.w, t); const scale = 1.0 - t*0.55; ctx.fillStyle = (col.status === 2) ? C.rot : C.vine; ctx.beginPath(); ctx.arc(x, y, 12*scale, 0, Math.PI*2); ctx.fill(); if(col.status === 1){ ctx.fillStyle = C.grape; const sz = 3*scale; ctx.beginPath(); ctx.arc(x-sz, y-sz, sz, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(x+sz, y-sz, sz, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(x, y+sz, sz, 0, Math.PI*2); ctx.fill(); } } }
            });
        }
    }
    class Worker{
        constructor(){ this.reset(true); }
        reset(isSpawn){
            this.x = Math.random() * 900; this.y = GROUND_Y + 10 + Math.random() * 40; this.speed = 0.55 + Math.random() * 0.85; this.isSick = state.isPlague && Math.random() > 0.4;
            const r = Math.random(); if(r < 0.25) this.trait='Mercenary'; else if(r < 0.5) this.trait='Desperate'; else if(r < 0.75) this.trait='Stubborn'; else this.trait='Steady';
            this.skin = this.isSick ? '#9acd32' : C.skin[Math.floor(Math.random()*3)]; this.hatColor = C.hats[this.trait]; this.shirt = '#ecf0f1'; this.minWage = 1; if(this.trait === 'Stubborn') this.minWage = 5;
            this.state='wandering'; this.targetVineyard=null; this.targetColObj=null; this.targetColIdx=-1; this.poachTimer=0; this.patience=50; this.animFrame = Math.random()*100;
        }
        abandonJob(){ if(this.targetVineyard){ if(this.targetColObj && this.targetColObj.worker === this){ this.targetColObj.worker = null; } else { this.targetVineyard.fireWorker(this); } } this.targetVineyard = null; this.targetColObj = null; this.targetColIdx = -1; }
        think(){
            if(this.isSick && Math.random() < 0.005){ this.abandonJob(); this.state = 'dying'; } if(this.state==='dying'){ this.patience--; if(this.patience < 0) this.state='dead'; return; }
            if(this.state==='working'){
                this.poachTimer++; if(this.poachTimer > 20 && Math.random() < 0.1){ const curWage = this.targetVineyard.wage; const better = state.vineyards.find(v => v.wage > curWage && v.openCols > 0); if(better){ this.targetVineyard.fireWorker(this); if(this.targetVineyard.isPlayer) state.floatingTexts.push(new FloatingText(this.x, this.y, "I QUIT!", '#e74c3c')); const col = better.assignWorker(this); if(col){ this.targetVineyard = better; this.targetColObj = col; this.targetColIdx = better.cols.indexOf(col); this.state='walkingToCol'; this.poachTimer=0; if(better.isPlayer) state.floatingTexts.push(new FloatingText(this.x, this.y, "HIRED!", '#2ecc71')); } else { this.state='wandering'; } return; } }
                if(this.targetColObj){ this.targetColObj.progress += HARVEST_SPEED; const v = this.targetVineyard; const baseX = v.x + this.targetColObj.x; const t = clamp(this.targetColObj.progress / 100, 0, 1); this.x = projectX(baseX, v.x, v.w, t); this.y = vineYFromPct(this.targetColObj.progress); if(this.targetColObj.progress >= 100){ this.targetVineyard.harvestCol(this.targetColIdx); this.state='leaving'; this.targetVineyard=null; this.targetColObj=null; } } return;
            }
            if(this.state==='leaving'){ if(this.y < GROUND_Y+10) this.y += LEAVING_Y_SPEED; else{ this.x += (this.speed * LEAVING_X_MULT); if(this.x > 950) this.state='dead'; } return; }
            if(this.state==='walkingToCol'){ const tx = this.targetVineyard.x + this.targetColObj.x; const ty = GROUND_Y; const dx = tx - this.x, dy = ty - this.y; const dist = Math.sqrt(dx*dx + dy*dy); const step = WALK_TO_COL_SPEED + this.speed*0.35; if(dist < 5){ this.state='working'; this.poachTimer=0; } else { this.x += (dx/dist)*step; this.y += (dy/dist)*step; } return; }
            if(this.state==='wandering'){ this.patience--; if(this.patience < 0){ this.minWage = Math.max(1, this.minWage - 1); this.patience = 50; } if(Math.random() < 0.2){ let options = state.vineyards.filter(v => v.openCols > 0 && v.wage >= this.minWage); if(options.length > 0){ options.sort(() => Math.random() - 0.5); options.sort((a,b) => b.wage - a.wage); const best = options[0]; const col = best.assignWorker(this); if(col){ this.targetVineyard = best; this.targetColObj = col; this.targetColIdx = best.cols.indexOf(col); this.state='walkingToCol'; if(best.isPlayer) state.floatingTexts.push(new FloatingText(this.x, this.y-20, "HIRED", '#2ecc71')); } } } this.x += (Math.random()-0.5) * WORKER_WANDER_X; this.y += (Math.random()-0.5) * WORKER_WANDER_Y; if(this.y < GROUND_Y) this.y = GROUND_Y; if(this.y > 500) this.y = 500; }
        }
        draw(){ if(this.state==='dead') return; let px=this.x, py=this.y; let s=1.0; if(py < GROUND_Y) s = 1.0 - ((GROUND_Y - py)/(GROUND_Y-HORIZON_Y))*0.5; if(this.state==='dying'){ ctx.fillStyle=this.shirt; ctx.fillRect(px, py, 14*s, 6*s); ctx.fillStyle='#c0392b'; ctx.font="12px monospace"; ctx.fillText("RIP", px, py-5); return; } this.animFrame++; const bob = Math.sin(this.animFrame*0.18)*1.4*s; ctx.fillStyle=this.hatColor; ctx.fillRect(px-2*s, py-16*s+bob, 14*s, 4*s); ctx.fillRect(px+2*s, py-19*s+bob, 6*s, 3*s); ctx.fillStyle=this.skin; ctx.fillRect(px+2*s, py-12*s+bob, 6*s, 6*s); ctx.fillStyle=this.shirt; ctx.fillRect(px, py-6*s+bob, 10*s, 10*s); }
    }
    function startGame(){ init(); }
    function init(){
        document.getElementById('game-over-screen').style.display='none'; canvas = document.getElementById('gameCanvas'); ctx = canvas.getContext('2d');
        state.year=1345; state.isPlague=false; state.month=0; state.monthTimer=0; state.population=[]; state.vineyards=[]; state.hills=[]; state.floatingTexts=[]; state.playerWage=5; state.avgWage=5; C.sky = '#87CEEB'; C.hills = '#27ae60';
        for(let i=0; i<900; i+=40) state.hills.push({x:i, y:HORIZON_Y - Math.random()*30});
        const startX = (900 - (5*160))/2 + 10; for(let i=0; i<5; i++) state.vineyards.push(new Vineyard(startX + i*160, i, i===PLAYER_IDX));
        for(let i=0; i<30; i++) state.population.push(new Worker());
        state.gameActive=true; gameLoop(); updateUI();
    }
    function gameLoop(){
        if(!state.gameActive) return; state.monthTimer++; if(state.monthTimer >= MONTH_FRAMES){ state.monthTimer=0; endMonth(); }
        let totWage=0; state.vineyards.forEach(v => { v.updateAI(); v.tickGrapes(); totWage += v.wage; }); state.avgWage = Math.floor(totWage / 5); state.targetPop = state.isPlague ? 10 : 25; state.population = state.population.filter(p => p.state !== 'dead');
        const spawnChance = state.isPlague ? 0.01 : 0.05; if(state.population.length < state.targetPop && Math.random() < spawnChance){ state.population.push(new Worker()); }
        state.population.forEach(p => p.think()); drawScene(); requestAnimationFrame(gameLoop);
    }
    function endMonth(){ state.month++; if(state.month > 11){ state.month=0; state.year++; if(state.year===1348) triggerPlague(); if(state.year===END_YEAR) showGameOver(); } updateUI(); }
    function triggerPlague(){ state.isPlague=true; document.getElementById('plague-ticker').style.display='block'; C.sky="#5e4b4b"; C.hills="#3e2723"; state.population.forEach(p => { if(Math.random() < 0.5) p.state='dead'; }); }
    function showGameOver(){
        state.gameActive=false; document.getElementById('game-over-screen').style.display='flex'; let html=""; const rankings = [...state.vineyards].sort((a,b)=>b.wealth - a.wealth); rankings.forEach((v, idx) => { const label = v.isPlayer ? "YOU" : v.aiType; const c = v.isPlayer ? "#f1c40f" : "#bdc3c7"; html += `<div style='color:${c}'>#${idx+1} ${label}: ${v.wealth}g</div>`; }); document.getElementById('leaderboard').innerHTML = html;
    }
    function drawScene(){
        ctx.clearRect(0,0,900,500); ctx.fillStyle=C.sky; ctx.fillRect(0,0,900,HORIZON_Y); ctx.fillStyle=C.hills; ctx.beginPath(); ctx.moveTo(0,HORIZON_Y); ctx.lineTo(0,HORIZON_Y-50); state.hills.forEach(p => ctx.lineTo(p.x, p.y)); ctx.lineTo(900, HORIZON_Y); ctx.fill(); ctx.fillStyle=C.ground; ctx.fillRect(0,HORIZON_Y,900,500);
        state.vineyards.forEach(v => v.draw()); state.population.sort((a,b)=>a.y - b.y); state.population.forEach(p => p.draw()); state.floatingTexts = state.floatingTexts.filter(ft => ft.life > 0); state.floatingTexts.forEach(ft => ft.draw()); document.getElementById('month-bar').style.width = (state.monthTimer/MONTH_FRAMES)*100 + "%";
    }
    function adjustWage(amt){ state.playerWage += amt; state.playerWage = clamp(state.playerWage, 1, AI.MAX_WAGE); state.vineyards[PLAYER_IDX].wage = state.playerWage; updateUI(); }
    function updateUI(){ document.getElementById('wageDisplay').innerText = state.playerWage + "g"; document.getElementById('wealthDisplay').innerText = state.vineyards[PLAYER_IDX].wealth + "g"; document.getElementById('avgWageDisplay').innerText = state.avgWage + "g"; document.getElementById('popDisplay').innerText = `${state.population.length}/${state.targetPop}`; document.getElementById('dateDisplay').innerText = state.year; const marketMax = Math.max(...state.vineyards.map(v => v.wage)); let hint=""; if(state.playerWage < marketMax) hint = "Competitor paying " + marketMax; else if(state.playerWage === marketMax) hint = "Tied for Leader"; else hint = "Market Leader"; document.getElementById('wageHint').innerText = hint; }
    function setupButtons(){ const minus = document.getElementById('btnMinus'); const plus  = document.getElementById('btnPlus'); const bind = (el, delta) => { el.addEventListener('pointerdown', (e) => { e.preventDefault(); el.setPointerCapture?.(e.pointerId); adjustWage(delta); }, {passive:false}); }; bind(minus, -1); bind(plus,  1); }
    window.onload = () => { setupButtons(); init(); };
</script>
</body>
</html>
    </textarea>

    <script>
        const menuScreen = document.getElementById('menu-screen');
        const gameFrame = document.getElementById('game-frame');
        const homeBtn = document.getElementById('home-btn');

        function playGame(gameType) {
            // 1. Get the raw HTML string from the textarea
            let code = "";
            if(gameType === 'urban') {
                code = document.getElementById('code-urban').value;
            } else if(gameType === 'farm') {
                code = document.getElementById('code-farm').value;
            }

            // 2. Hide Menu, Show Game
            menuScreen.style.display = 'none';
            gameFrame.style.display = 'block';
            homeBtn.style.display = 'block';

            // 3. Inject code into iframe
            //    (This isolates the game scripts so they don't crash each other)
            gameFrame.srcdoc = code;
        }

        function goHome() {
            // 1. Wipe the iframe so the game loop stops running in background
            gameFrame.srcdoc = "";

            // 2. Hide Game, Show Menu
            gameFrame.style.display = 'none';
            homeBtn.style.display = 'none';
            menuScreen.style.display = 'flex';
        }
    </script>
</body>
</html>

